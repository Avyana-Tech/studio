name: Push the app to Snap

on:
  release:
    types: [ prereleased, released ]

jobs:
  snap:
    name: Publish to Snap
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true
          ssh-key: ${{secrets.repo_ssh}}

      - uses: actions/setup-node@v3.4.1
        with:
          node-version: 14.x
          cache: yarn

      - run: yarn install --immutable

      - name: Download release binaries
        working-directory: ci/apt
        run: yarn ts-node downloadReleases.ts

      - run: ls -la ci/apt/packages

      - uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_LOGIN }}
        with:
          snap: ci/apt/packages/foxglove-studio-${{ steps.studio-version.outputs.version }}-linux-amd64.snap
          release: stable
